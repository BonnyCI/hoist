---
- name: Common task for all nodes
  hosts: all
  become: yes
  tags: ['common']
  roles:
    - role: common
    - role: dd-agent
      tags:
        - monitoring

- name: Install mysql
  hosts: mysql
  become: yes
  tags: ['mysql']
  roles:
    - role: mysql
    - role: dd-mysql
      dd_mysql_password: "{{ secrets.datadog.mysql_password }}"
      tags:
        - monitoring
    - role: databases

- name: Install zuul
  hosts: zuul
  become: yes
  tags: ['zuul']
  roles:
    - role: gearman
    - role: dd-gearman
      tags:
        - monitoring
    - role: zuul
      zuul_gearman_server_start: false
      zuul_statsd_enable: yes
      zuul_connections:
        portbleu:
          driver: gerrit
          port: 29418
          server: review.portbleu.com
          sshkey: /var/lib/zuul/.ssh/id_rsa
          user: bonnyci
    - role: dd-zuul
      tags:
        - monitoring

- name: Install nodepool
  hosts: nodepool
  become: yes
  tags: ['nodepool']
  roles:
    - role: nodepool
      nodepool_statsd_enable: yes
      nodepool_mysql_user: "{{ secrets.nodepool.db_user }}"
      nodepool_mysql_password: "{{ secrets.nodepool.db_password }}"
