---
- name: Validate mysql
  hosts: mysql
  tasks:
    - name: mysql is running
      command: pgrep -f /usr/sbin/mysql

- name: Validate zuul
  hosts: zuul
  tasks:
    - name: zuul services are running
      command: pgrep -f {{ item }}
      with_items:
        - /opt/venvs/zuul/bin/zuul-server
        - /opt/venvs/zuul/bin/zuul-merger
        - /opt/venvs/zuul/bin/zuul-launcher

    - name: gearman services are running
      shell: netstat -antlp | grep 4730

    - name: get gear status
      shell: echo "status" | nc -w 1 127.0.0.1 4730
      register: gearstat

    - name: validate gear status
      assert:
        that:
          - gearstat.stdout | search("node_assign:zuul")
          - gearstat.stdout | search("merger:merge")
          - gearstat.stdout | search("merger:update")

- name: Validate nodepool
  hosts: nodepool
  tasks:
    - name: nodepool services are running
      command: pgrep -f /opt/venvs/nodepool/bin/nodepoold

    - name: validate nodepool operation
      become: yes
      become_user: nodepool
      command: /opt/venvs/nodepool/bin/nodepool {{ item }}
      with_items:
        - config-validate
        - list
        - job-list
        - dib-image-list

- name: Validate log server
  hosts: log
  tasks:
    - name: logstash is running on filebeat port
      become: yes
      become_user: logstash
      shell: lsof -nPi :5044 | grep LISTEN

    - name: copy example console log
      become: yes
      copy:
        src: logs/example.log
        dest: "{{ bonnyci_logs_root_dir}}/console.log"
        mode: "0444"

- name: Validate logs are served
  hosts: localhost
  tasks:
    - name: test logs are served
      shell: curl --fail {{ bonnyci_logs_apache_server_name }}/console.log

    - name: system logs served
      shell: curl --fail {{ bonnyci_system_logs_apache_server_name }}/system-logs/
